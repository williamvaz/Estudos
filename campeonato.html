<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Estudos Futebol ‚Ä¢ Campeonato</title>
  <base href="/Estudos/">
  <meta name="theme-color" content="#0b3b22" />
  <link rel="stylesheet" href="home.css" />
  <style>
    :root { color-scheme: dark; }
    body { color:#fff; }

    .container{ max-width:980px; margin:0 auto; padding:12px; display:flex; flex-direction:column; gap:12px; }
    .card{ background:rgba(0,0,0,.15); border:1px solid rgba(255,255,255,.08);
           border-radius:14px; padding:12px; }
    .row{ display:grid; gap:12px; }
    @media (min-width: 860px){ .row{ grid-template-columns: 1fr 1fr; } }

    .team-card{ display:flex; flex-direction:column; gap:10px; align-items:center; }
    .flag{ width:120px; height:80px; object-fit:cover; border-radius:10px;
           box-shadow:0 0 0 1px rgba(0,0,0,.3) inset, 0 8px 22px rgba(0,0,0,.4); }
    .team-name{ font-weight:800; font-size:1.05rem; text-align:center; }
    .score{ font-size:1.25rem; font-weight:800; background:#102618; border:1px solid #284b34;
            padding:6px 12px; border-radius:999px; }

    /* Radar */
    .radar{ width:260px; height:220px; }
    .legend{ display:flex; flex-wrap:wrap; gap:8px 12px; justify-content:center; font-size:.85rem; opacity:.85 }
    .badge{ padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.05); }

    /* rodap√© fixo */
    .footer-actions{
      position: fixed; left:0; right:0; bottom:0; z-index: 1000;
      padding: 10px max(12px, env(safe-area-inset-left)) calc(10px + env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-right));
      background: rgba(10,18,12,.85); backdrop-filter: blur(6px);
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px;
    }
    .btn{ flex:1; text-align:center; padding:12px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
          color:#fff; text-decoration:none; font-weight:800; }
    .btn-primary{ background:#22c55e; color:#092015; border-color:#22c55e; }
    .btn-secondary{ background:#0f1f15; }
    .muted{ opacity:.8; }
    .warn{ background:#2a1c1c; border-color:#553a3a; color:#ffd0d0; padding:12px; border-radius:10px; }
  </style>
</head>
<body class="is-mobile">
  <header class="topbar">
    <div class="brand">
      <span class="ball">üèÜ</span>
      <h1>Campeonato</h1>
      <a class="back small" href="index.html" style="margin-left:auto">‚Üê In√≠cio</a>
    </div>
  </header>

  <main class="container">
    <!-- Status/erros -->
    <div id="status" class="muted small"></div>

    <!-- Pr√≥ximo confronto -->
    <section class="card">
      <!-- [CHANGE] t√≠tulo do confronto fica din√¢mico conforme o plano -->
      <div id="fixture-info" class="small muted" style="margin-bottom:6px">Pr√≥ximo confronto</div>
      <div class="row" id="match">
        <!-- time A -->
        <div class="team-card" id="t1">
          <img class="flag" id="t1-flag" alt="">
          <div class="team-name" id="t1-name">‚Äî</div>
          <div class="score">Score: <span id="t1-score">‚Äî</span></div>
          <svg class="radar" id="t1-radar" viewBox="0 0 260 220" aria-hidden="true"></svg>
          <div class="legend">
            <span class="badge">ATK</span><span class="badge">DFS</span><span class="badge">MEI</span><span class="badge">VEL</span><span class="badge">ENT</span>
          </div>
        </div>
        <!-- time B -->
        <div class="team-card" id="t2">
          <img class="flag" id="t2-flag" alt="">
          <div class="team-name" id="t2-name">‚Äî</div>
          <div class="score">Score: <span id="t2-score">‚Äî</span></div>
          <svg class="radar" id="t2-radar" viewBox="0 0 260 220" aria-hidden="true"></svg>
          <div class="legend">
            <span class="badge">ATK</span><span class="badge">DFS</span><span class="badge">MEI</span><span class="badge">VEL</span><span class="badge">ENT</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- bot√µes fixos -->
  <div class="footer-actions">
    <a class="btn btn-primary" href="jogar.html">Jogar</a>
    <a class="btn btn-secondary" href="tabela.html">Ver tabelas</a>
  </div>

  <script>
  // ===========================
  // CONFIG / CHAVES
  // ===========================
  const CHAMP = 'CONCACAF'; // campeonato de fallback quando n√£o houver plano
  const CHAMPS = ['CONMEBOL','CONCACAF','CAF','AFC','OFC','UEFA','CONFEDERACOES','COPA DO MUNDO'];
  const LKEY_INIT = 'iniciado';
  const LKEY_STATE_V3 = 'team_state_v3'; // { [id]: { score, atk, dfs, mei, vel, ent, sequencia_reg: { CHAMP: n } } }
  const LKEY_NEXT1 = 'Nextvs1'; // compat (fallback)
  const LKEY_NEXT2 = 'Nextvs2'; // compat (fallback)

  // [CHANGE] novas chaves para plano/resultados/slots
  const LKEY_PLAN    = 'fixtures_plan_flat_v1'; // array linear de jogos
  const LKEY_RESULTS = 'fixtures_results_v1';   // { [JOGO]: { ...resultado... } }
  const LKEY_SLOTS   = 'bracket_slots_v1';      // { [comp_id]: { [slot]: "Nome do Pa√≠s" } }

  // ===========================
  // HELPERS: storage e dados
  // ===========================
  const jget = (k, fb) => { try { const v = JSON.parse(localStorage.getItem(k) || ''); return v ?? fb; } catch { return fb; } };
  const jset = (k, v) => localStorage.setItem(k, JSON.stringify(v));
  const clamp = (n,a,b) => Math.max(a, Math.min(b, Number(n)||0));

  // tenta obter a lista de sele√ß√µes de alguma fonte do projeto
  function loadTeams(){
    // 1) fontes globais
    if (Array.isArray(window.SELECOES)) return window.SELECOES;
    if (Array.isArray(window.TEAMS)) return window.TEAMS;
    // 2) localStorage (ex.: voc√™ pode salvar sua lista em 'teams')
    const ls = jget('teams', []);
    if (Array.isArray(ls) && ls.length) return ls;
    return []; // sem dados
  }
  // normaliza propriedades (aceita ID por nome ou code)
  function normTeam(t){
    const conf = (t.conf || t.confederacao || t.region || t.regiao || t.campeonato || '').toString().toUpperCase().trim();
    const code = (t.code || t.cod || t.sigla || t.id || '').toString().toUpperCase().trim();
    const name = (t.name || t.nome || t.country || t.pais || '').toString().trim();
    let flag = (t.flag || t.bandeira || '').toString().trim();
    if (!flag && name) flag = `Flags/${name}.jpg`; // fallback padr√£o do teu projeto
    return { code, name, conf, flag };
  }

  // [CHANGE] agora indexamos por "qualquer chave": code OU name.
  // byKey permite procurar pelo ID salvo no state, seja ele code ou nome.
  function indexTeams(raw){
    const all = raw.map(normTeam).filter(x => (x.code || x.name) && x.conf);
    const byKey = {};
    const byChamp = {};
    for (const c of CHAMPS) byChamp[c] = [];
    for (const t of all){
      if (t.code) byKey[t.code] = t;
      if (t.name) byKey[t.name] = t; // chaveia pelo nome tamb√©m
      if (CHAMPS.includes(t.conf)) byChamp[t.conf].push(t);
    }
    return { all, byKey, byChamp };
  }

  // ===========================
  // STATE V3 (por time)
  // ===========================
  function loadStateV3(){ return jget(LKEY_STATE_V3, {}); }
  function saveStateV3(s){ jset(LKEY_STATE_V3, s); }

  function ensureTeamBaseline(s, id){
    if (!s[id]) s[id] = {};
    const st = s[id];
    st.score = clamp(st.score ?? 250, 1, 9999);
    st.atk = clamp(st.atk ?? 50, 1, 100);
    st.dfs = clamp(st.dfs ?? 50, 1, 100);
    st.mei = clamp(st.mei ?? 50, 1, 100);
    st.vel = clamp(st.vel ?? 50, 1, 100);
    st.ent = clamp(st.ent ?? 50, 1, 100);
    if (!st.sequencia_reg || typeof st.sequencia_reg !== 'object') st.sequencia_reg = {};
    return st;
  }

  // gera 1..N aleat√≥rio √∫nico
  function shuffled1toN(n){
    const arr = Array.from({length:n}, (_,i)=>i+1);
    for (let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  // inicializa√ß√£o total (rodada 1x quando 'iniciado' inexistente/0)
  function firstRunInit(byChamp){
    const state = loadStateV3();

    // para cada campeonato, aplica sequ√™ncia √∫nica 1..N
    for (const champ of CHAMPS){
      const list = byChamp[champ] || [];
      if (!list.length) continue;
      const seq = shuffled1toN(list.length);
      list.forEach((t, idx) => {
        // [CHANGE] ID pode ser nome OU code; preferimos nome se existir
        const id = t.name || t.code;
        const st = ensureTeamBaseline(state, id);
        st.sequencia_reg[champ] = seq[idx]; // salva mapeado por campeonato
      });
    }

    saveStateV3(state);
    localStorage.setItem(LKEY_INIT, '1');
  }

  // encontra time por sequencia_reg e campeonato (retorna ID salvo no state)
  function findBySeq(champ, seq){
    const state = loadStateV3();
    for (const id in state){
      const st = state[id];
      if (st?.sequencia_reg?.[champ] === seq) return id;
    }
    return null;
  }

  // ===========================
  // Plano / Resultados / Slots (mata-mata)
  // ===========================
  function loadPlan(){ return jget(LKEY_PLAN, []); }
  function loadResults(){ return jget(LKEY_RESULTS, {}); }
  function loadSlots(){ return jget(LKEY_SLOTS, {}); }

  // [CHANGE] resolve um participante a partir da refer√™ncia do plano
  // suporta: {type:'seed', champ, seq} | {type:'slot', comp_id, slot} | {type:'name', name} | {type:'code', code}
  function resolveRef(ref){
    if (!ref) return null;
    const type = String(ref.type||'').toLowerCase();
    if (type === 'seed'){
      const { champ, seq } = ref;
      const id = findBySeq(champ, Number(seq));
      return id;
    }
    if (type === 'slot'){
      const { comp_id, slot } = ref;
      const slots = loadSlots();
      const name = slots?.[comp_id]?.[slot] || null; // nome do pa√≠s
      return name || null; // nosso ID √© o pr√≥prio nome
    }
    if (type === 'name'){
      return ref.name || null;
    }
    if (type === 'code'){
      return ref.code || null;
    }
    return null;
  }

  // [CHANGE] acha o primeiro jogo do plano ainda n√£o conclu√≠do
  function getNextFixture(){
    const plan = loadPlan();
    const results = loadResults();
    if (!Array.isArray(plan) || plan.length === 0) return null;
    for (const item of plan){
      const jid = String(item.JOGO);
      if (!results || !results.hasOwnProperty(jid)) return item;
    }
    return null; // todos jogados
  }

  // ===========================
  // Fallback: NEXT VS simples (se n√£o existir plano)
  // ===========================
  function ensureNextMatchFallback(champ){
    let n1 = jget(LKEY_NEXT1, null);
    let n2 = jget(LKEY_NEXT2, null);

    if (!n1 || !n1.id){
      const id1 = findBySeq(champ, 1);
      if (id1) n1 = { id: id1, champ }; else n1 = null;
      if (n1) jset(LKEY_NEXT1, n1);
    }
    if (!n2 || !n2.id){
      const id2 = findBySeq(champ, 2);
      if (id2) n2 = { id: id2, champ }; else n2 = null;
      if (n2) jset(LKEY_NEXT2, n2);
    }
    return { n1, n2 };
  }

  // ===========================
  // UI: Radar (SVG)
  // ===========================
  function drawRadar(svg, stats){
    // stats: { atk, dfs, mei, vel, ent }  (1..100)
    const W=260, H=220, cx=130, cy=110, R=85;
    const axes = ['atk','dfs','mei','vel','ent'];
    const angles = axes.map((_,i)=> -Math.PI/2 + i*(2*Math.PI/axes.length));

    // limpa
    svg.innerHTML='';

    // grid
    const g = 4; // 4 an√©is
    for (let r=R/g; r<=R; r+=R/g){
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',r);
      c.setAttribute('fill','none'); c.setAttribute('stroke','rgba(255,255,255,.12)'); c.setAttribute('stroke-width','1');
      svg.appendChild(c);
    }
    // eixos
    for (const ang of angles){
      const x = cx + Math.cos(ang)*R;
      const y = cy + Math.sin(ang)*R;
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1',cx); line.setAttribute('y1',cy);
      line.setAttribute('x2',x);  line.setAttribute('y2',y);
      line.setAttribute('stroke','rgba(255,255,255,.15)');
      line.setAttribute('stroke-width','1');
      svg.appendChild(line);
    }
    // pol√≠gono
    const pts = angles.map((ang,i)=>{
      const key = axes[i];
      const v = clamp(stats[key]||0, 0, 100) / 100;
      const x = cx + Math.cos(ang)*R*v;
      const y = cy + Math.sin(ang)*R*v;
      return `${x},${y}`;
    }).join(' ');
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', pts);
    poly.setAttribute('fill','rgba(56,189,248,.25)');
    poly.setAttribute('stroke','rgba(56,189,248,.9)');
    poly.setAttribute('stroke-width','2');
    svg.appendChild(poly);
  }

  // ===========================
  // RENDER
  // ===========================
  function renderTeam(slotId, team, state){
    const nameEl   = document.getElementById(`${slotId}-name`);
    const flagEl   = document.getElementById(`${slotId}-flag`);
    const scoreEl  = document.getElementById(`${slotId}-score`);
    const radarEl  = document.getElementById(`${slotId}-radar`);

    if (!team){
      nameEl.textContent = '‚Äî';
      flagEl.removeAttribute('src');
      scoreEl.textContent = '‚Äî';
      radarEl.innerHTML = '';
      return;
    }
    nameEl.textContent = team.name || team.code || '‚Äî';
    flagEl.src = team.flag || '';
    scoreEl.textContent = state.score ?? '‚Äî';
    drawRadar(radarEl, {
      atk: state.atk, dfs: state.dfs, mei: state.mei, vel: state.vel, ent: state.ent
    });
  }

  function showStatus(msg){
    const el = document.getElementById('status');
    if (!el) return;
    el.innerHTML = msg || '';
  }

  // [CHANGE] legenda do confronto (de onde vieram os times)
  function setFixtureInfo(text){
    const el = document.getElementById('fixture-info');
    if (el) el.textContent = text || 'Pr√≥ximo confronto';
  }

  // ===========================
  // BOOT
  // ===========================
  (function init(){
    const teamsRaw = loadTeams();
    const { byKey, byChamp } = indexTeams(teamsRaw);

    if (!Object.keys(byChamp).length){
      showStatus('<div class="warn">Nenhuma sele√ß√£o encontrada. Carregue a lista de sele√ß√µes (window.SELECOES / window.TEAMS ou localStorage "teams").</div>');
      return;
    }

    // 1) iniciado?
    const iniciado = Number(localStorage.getItem(LKEY_INIT) || 0);
    if (!iniciado){
      firstRunInit(byChamp); // gera sequ√™ncias e salva
    }

    // 2) tenta montar pelo PLANO linear (sem JOGO.json, usa resultados para achar o primeiro pendente)
    const fixture = getNextFixture();

    let id1=null, id2=null, info='Pr√≥ximo confronto';
    if (fixture){
      id1 = resolveRef(fixture.Nextvs1);
      id2 = resolveRef(fixture.Nextvs2);

      // monta um texto amig√°vel da origem
      const sideDesc = (ref)=>{
        if (!ref) return '‚Äî';
        const t = String(ref.type||'').toLowerCase();
        if (t==='seed') return `${ref.champ} #${ref.seq}`;
        if (t==='slot') return `${ref.comp_id}:${ref.slot}`;
        if (t==='name') return `${ref.name}`;
        if (t==='code') return `${ref.code}`;
        return '‚Äî';
      };
      info = `Jogo ${fixture.JOGO} ‚Äî ${sideDesc(fixture.Nextvs1)} vs ${sideDesc(fixture.Nextvs2)}`;
      setFixtureInfo(info);
    }

    // 3) se n√£o houver plano, cai no fallback (pares 1√ó2 do campeonato padr√£o)
    if (!id1 || !id2){
      const fb = ensureNextMatchFallback(CHAMP);
      id1 = id1 || fb.n1?.id || null;
      id2 = id2 || fb.n2?.id || null;
      if (!fixture) setFixtureInfo(`Pr√≥ximo confronto (${CHAMP})`);
    }

    // 4) Render
    const st = loadStateV3();

    // garante baseline
    if (id1){ ensureTeamBaseline(st, id1); }
    if (id2){ ensureTeamBaseline(st, id2); }
    saveStateV3(st);

    // resolve objetos do cat√°logo (byKey aceita nome OU c√≥digo)
    const t1 = id1 ? (byKey[id1] || { name:id1, flag:`Flags/${id1}.jpg` }) : null;
    const t2 = id2 ? (byKey[id2] || { name:id2, flag:`Flags/${id2}.jpg` }) : null;

    if (!t1 || !t2){
      showStatus('<div class="warn">N√£o foi poss√≠vel montar o pr√≥ximo confronto. Verifique o plano ou as sequ√™ncias.</div>');
    } else {
      showStatus('');
    }

    renderTeam('t1', t1, id1 ? st[id1] : {} );
    renderTeam('t2', t2, id2 ? st[id2] : {} );
  })();
  </script>
</body>

<style>
  /* ==== Compacta a tela do Campeonato (overrides) ==== */
  :root{
    --flag-w: 88px;
    --flag-h: 58px;
    --radar-w: 180px;
    --radar-h: 150px;
    --name-fs: .95rem;
    --score-fs: 1rem;
    --gap: 8px;
  }

  .card{ padding:10px; }
  .row{ gap:10px; }

  .team-card{ gap: var(--gap); }
  .flag{ width: var(--flag-w); height: var(--flag-h); border-radius: 8px; }
  .team-name{ font-size: var(--name-fs); }
  .score{ font-size: var(--score-fs); padding: 4px 10px; border-radius: 999px; }

  .radar{ width: var(--radar-w); height: var(--radar-h); }
  .legend{ gap:6px 8px; font-size:.78rem; }
  .badge{ padding:2px 6px; }

  .footer-actions{
    padding:8px 12px calc(8px + env(safe-area-inset-bottom)) 12px;
  }
  .btn{ padding:10px 12px; border-radius:10px; font-weight:700; }
  
  /* ainda menor no S23/viewport estreita */
  @media (max-width: 410px){
    :root{
      --flag-w: 80px;
      --flag-h: 52px;
      --radar-w: 160px;
      --radar-h: 130px;
      --name-fs: .9rem;
      --score-fs: .95rem;
      --gap: 6px;
    }
    .legend{ font-size:.72rem; }
  }
</style>

</html>
