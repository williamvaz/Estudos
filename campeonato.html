<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b3b22" />
  <title>Estudos Futebol ‚Ä¢ In√≠cio</title>

  <!-- √çcones -->
  <link rel="icon" type="image/webp" href="Icone.webp" />
  <link rel="apple-touch-icon" href="Icone.webp" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Copa English">

  <link rel="stylesheet" href="home.css">
  <style>
    /* Banner de instala√ß√£o (bem simples) */
    .install-banner{
      position: fixed; inset: auto 0 0 0; display:none;
      background:#12382a; color:#fff; padding:12px 16px;
      box-shadow: 0 -6px 20px rgba(0,0,0,.3); z-index: 9999;
      font: 600 15px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .install-banner .row{display:flex; gap:12px; align-items:center; justify-content:space-between;}
    .install-banner button{
      border:0; padding:10px 14px; border-radius:10px; cursor:pointer;
    }
    .install{background:#2fd47a; color:#092015; font-weight:700;}
    .fechar{background:#2a2a2a; color:#fff;}
    @media (display-mode: standalone) {
      .install-banner{display:none !important;}
    }
  </style>
</head>
<body class="is-mobile">
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <span class="ball" aria-hidden="true">‚öΩ</span>
        <h1 class="brand-title">Copa English</h1>
      </div>
    </header>

    <section class="menu-grid" aria-label="A√ß√µes principais">
      <a class="menu-card" href="campeonato.html" id="btnPlay">
        <div class="icon">üèÜ</div><div class="title">Jogar</div>
        <div class="descr">Inicie um campeonato</div>
      </a>

      <a class="menu-card" href="selecoes.html">
        <div class="icon">üåç</div><div class="title">Lista de Sele√ß√µes</div>
        <div class="descr">Bandeiras, score e atributos</div>
      </a>

      <a class="menu-card" href="palavras.html">
        <div class="icon">üìö</div><div class="title">Lista de Palavras</div>
        <div class="descr">Seu banco para revis√£o</div>
      </a>

      <a class="menu-card" href="edicoes.html">
        <div class="icon">üìú</div><div class="title">Hist√≥rico de Edi√ß√µes</div>
        <div class="descr">Anfitri√µes e campe√µes</div>
      </a>
    </section>
  </div>

  <!-- Banner de instala√ß√£o -->
  <div id="installBanner" class="install-banner" role="dialog" aria-live="polite" aria-label="Instalar aplicativo">
    <div class="row">
      <div>Instalar ‚ÄúCopa English‚Äù na tela inicial?</div>
      <div>
        <button class="fechar" id="btnFechar">Agora n√£o</button>
        <button class="install" id="btnInstalar">Instalar</button>
      </div>
    </div>
  </div>

  <script>
  // --- PWA (mantive sua l√≥gica) ---
  if ('serviceWorker' in navigator) {
    // certifique-se que o nome aqui √© o do seu arquivo real (service-worker.js ou sw.js)
    navigator.serviceWorker.register('./service-worker.js').catch(console.error);
  }

  let deferredPrompt = null;
  const banner = document.getElementById('installBanner');
  const btnInstalar = document.getElementById('btnInstalar');
  const btnFechar = document.getElementById('btnFechar');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const jaMostrado = localStorage.getItem('pwaPromptMostrado') === '1';
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    if (!jaMostrado && isMobile && !isStandalone) banner.style.display = 'block';
  });

  btnInstalar?.addEventListener('click', async () => {
    localStorage.setItem('pwaPromptMostrado', '1');
    banner.style.display = 'none';
    if (deferredPrompt) {
      deferredPrompt.prompt();
      try { await deferredPrompt.userChoice; } finally { deferredPrompt = null; }
    }
  });
  btnFechar?.addEventListener('click', () => {
    localStorage.setItem('pwaPromptMostrado', '1');
    banner.style.display = 'none';
  });

  // --------- FLUXO "JOGAR" ----------
  // limites por confedera√ß√£o (sem repetir)
  const RANGE_BY_CONF = {
    CONCACAF: 41,
    CONMEBOL: 10,
    OFC:      13,
    AFC:      47,
    CAF:      56,
    UEFA:     55,
  };

  const LKEY_SEQ   = 'seqreg';               // { [teamCode]: "UEFA33" ... }
  const LKEY_START = 'campeonatoiniciado';   // "0" | "1"
  const LKEY_HOST  = 'anfitriao';            // teamCode

  // util: normaliza sele√ß√µes do Selecoes.json
  function slugify(str){
    return String(str).normalize('NFD').replace(/\p{Diacritic}/gu,'')
      .toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
  }
  function normalizeSelecoes(raw){
    return (raw||[]).map(s => {
      const name = s.Team || s.name || s.nome;
      return {
        code: slugify(name),
        name,
        confed: s.Tournament || s.confed || s.continente || s.federacao, // AFC/CAF/...
        flag:  s.Path || s.flag || s.bandeira
      };
    }).filter(s => s.code && s.name && s.confed);
  }

  // utils: aleatoriedade sem repeti√ß√£o
  function range(n){ return Array.from({length:n}, (_,i)=>i+1); }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random() * (i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  async function ensureFirstEdition() {
    // j√° iniciado?
    const started = localStorage.getItem(LKEY_START);
    if (started === '1') return true;

    // carrega sele√ß√µes
    let selecoes = [];
    try {
      const r = await fetch('Selecoes.json', { cache:'no-store' });
      if (!r.ok) throw new Error('HTTP '+r.status);
      selecoes = normalizeSelecoes(await r.json());
    } catch (e) {
      alert('N√£o consegui carregar Selecoes.json. Verifique o arquivo na raiz do projeto.');
      throw e;
    }

    // agrupa por confedera√ß√£o
    const byConf = {};
    for (const s of selecoes) {
      (byConf[s.confed] ||= []).push(s);
    }

    // monta seqreg: para cada confedera√ß√£o, sorteia uma permuta√ß√£o 1..Nlimite
    const seqreg = {};
    for (const conf of Object.keys(byConf)) {
      const limite = RANGE_BY_CONF[conf];
      if (!limite) continue; // ignora confedera√ß√µes n√£o mapeadas

      const pool = shuffle(range(limite)); // ex: [7,1,3, ...] sem repetir
      // atribui n√∫meros aos times dessa confedera√ß√£o (se exceder o limite, recicla ‚Äî mas n√£o deve no seu dataset)
      byConf[conf].forEach((team, idx) => {
        const num = pool[idx % pool.length];
        seqreg[team.code] = `${conf}${num}`;
      });
    }

    // anfitri√£o aleat√≥rio
    const host = selecoes[Math.floor(Math.random() * selecoes.length)]?.code || '';

    // persiste
    localStorage.setItem(LKEY_SEQ, JSON.stringify(seqreg));
    localStorage.setItem(LKEY_HOST, host);
    localStorage.setItem(LKEY_START, '1');

    // feedback
    alert('Edi√ß√£o iniciada');

    return true;
  }

  // click handler do card Jogar
  document.getElementById('btnPlay')?.addEventListener('click', async (e) => {
    e.preventDefault();
    try {
      const started = localStorage.getItem(LKEY_START);
      if (started === '1') {
        // j√° iniciado ‚Üí s√≥ entrar
        window.location.href = 'campeonato.html';
        return;
      }
      // primeira vez ‚Üí criar edi√ß√£o
      const ok = await ensureFirstEdition();
      if (ok) window.location.href = 'campeonato.html';
    } catch (err) {
      console.error(err);
      // fallback: n√£o bloquear navega√ß√£o
      window.location.href = 'campeonato.html';
    }
  });
</script>

</body>
</html>
