<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Copa English • Tabela</title>
<style>
  :root{
    --bg:#113a2f;
    --panel:#0e2e26;
    --panel-2:#0a261f;
    --accent:#19c37d;
    --soft:#ffffff0f;
    --text:#eef6f3;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:#2b1f24;font-family:system-ui,Segoe UI,Roboto,Inter,Arial}
  .app{max-width:420px;margin:0 auto;background:var(--bg);min-height:100dvh;color:var(--text)}
  header{display:flex;align-items:center;gap:.5rem;padding:.8rem 1rem;background:linear-gradient(180deg,#0c2b23,#0b251f);position:sticky;top:0;z-index:5;border-bottom:1px solid #ffffff10}
  header .back{appearance:none;border:0;background:transparent;color:var(--text);font-size:20px;cursor:pointer;padding:.2rem .4rem;border-radius:.6rem}
  header .back:hover{background:#ffffff13}
  header h1{font-size:15px;margin:0;font-weight:700;opacity:.95}
  .screen{padding:1rem .9rem 2rem;display:none}
  .screen.active{display:block}
  h2{font-size:15px;letter-spacing:.03em;margin:.6rem 0 1rem}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid #ffffff12;border-radius:14px;padding:.9rem;box-shadow:0 10px 24px #00000030}
  .card h3{margin:.3rem 0 1rem;font-size:12px;opacity:.9;font-weight:700;letter-spacing:.06em}
  .item{background:radial-gradient(120px 60px at 50% -40px,#ffffff10,transparent 60%),#133e32;border:1px solid #ffffff16;border-radius:14px;padding:1rem .9rem;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:.15s transform}
  .item:hover{border-color:#ffffff30;transform:translateY(-1px)}
  .badge{background:#ffffff14;border:1px solid #ffffff22;color:#fff;height:28px;width:28px;display:grid;place-items:center;border-radius:999px;font-size:13px;margin-right:.5rem}
  .row{display:flex;align-items:center;gap:.6rem}
  .muted{opacity:.6;font-size:12px;margin:.2rem 0 .8rem}
  .list{display:grid;gap:.6rem}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{padding:.35rem .4rem;text-align:center;border-bottom:1px dashed #ffffff18}
  th{font-weight:700;opacity:.9}
  .sub{font-size:11px;opacity:.9;margin:.5rem 0 .7rem}
  .logo{height:28px;width:28px;object-fit:contain;border-radius:4px;background:#0d2922;padding:2px;border:1px solid #ffffff20;margin-right:.5rem}
  .pill{font-size:11px;border:1px solid #ffffff20;border-radius:999px;padding:.15rem .5rem;opacity:.85}
  .stack{display:grid;gap:.8rem}
  .section-title{font-weight:800;letter-spacing:.08em;text-transform:uppercase;font-size:13px;margin:.2rem 0 .6rem;opacity:.9}
  .warning{background:#40251d;border:1px solid #c77b3a;padding:.6rem .7rem;border-radius:10px;color:#ffd7b1;font-size:12px}
  a.btnlink,button.btnlink{display:inline-block;margin-top:.8rem;padding:.55rem .8rem;border-radius:10px;border:1px solid #ffffff22;text-decoration:none;color:#fff;background:#0e2e26}
  .tabs{display:flex;gap:.5rem;margin:.6rem 0}
  .tab{padding:.35rem .6rem;border:1px solid #ffffff22;border-radius:999px;font-size:12px;cursor:pointer;background:#0d2b23}
  .tab.active{background:#124b3b;border-color:#ffffff40}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <button class="back" id="btnBack" aria-label="Voltar">←</button>
    <h1>⚽ Copa English • Tabela</h1>
  </header>

  <!-- Nível 1: Seleção de Torneio -->
  <section id="scrTorneios" class="screen active">
    <h2>SELECIONE O TORNEIO</h2>
    <p class="muted">Toque em um torneio para ver os grupos.</p>
    <div class="grid" id="torneiosGrid"></div>
  </section>

  <!-- Nível 2: Seleção de Grupo -->
  <section id="scrGrupos" class="screen">
    <h2>SELECIONE O GRUPO</h2>
    <div id="gruposWrap" class="stack"></div>
  </section>

  <!-- Nível 3: Grupo -> Resultados + Classificação -->
  <section id="scrGrupoView" class="screen">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div id="grupoHeader" class="row"></div>
      <span id="fasePill" class="pill">Fase de Grupos</span>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabGrupos">Fase de Grupos</button>
      <button class="tab" id="tabMata">Mata‑mata</button>
    </div>

    <div id="viewGrupos">
      <div class="card" style="margin-top:.4rem">
        <h3>Resultados</h3>
        <div id="resultados"></div>
      </div>
      <div class="card" style="margin-top:.8rem">
        <h3>Classificação</h3>
        <div id="classificacao"></div>
      </div>
    </div>
    <div id="viewMata" style="display:none">
      <div class="card" style="margin-top:.4rem">
        <h3>Chave (Mata‑mata)</h3>
        <div id="knockout"></div>
      </div>
    </div>

    <div id="msg" style="margin-top:.8rem"></div>
    <button class="btnlink" id="btnVoltarCampeonato" type="button">Voltar para Campeonato</button>
  </section>
</div>

<script>
/* === UTIL === */
const $ = sel => document.querySelector(sel);
const el = (tag, attrs={}, children=[]) => {
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='text') e.textContent = v;
    else if(k==='html') e.innerHTML = v;
    else if(k==='class') e.className = v;
    else e.setAttribute(k,v);
  });
  (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>e.appendChild(c));
  return e;
};
const ABC = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
const LOGOS = {
  "AFC": "Logos/AFC.png",
  "CAF": "Logos/CAF.png",
  "CONCACAF": "Logos/CONCACAF.png",
  "CONMEBOL": "Logos/CONMEBOL.svg",
  "OFC": "Logos/OFC.png",
  "UEFA": "Logos/UEFA.svg",
  "FIFA": "Logos/Copa do mundo.png",
  "Copa das Confederações": "Logos/Copa das confederações.png"
};

/* === STATE/ROUTER === */
let state = {
  torneios: [],
  torneio: null,
  grupoKey: null,
  grupoTimes: []
};

const rota = () => decodeURIComponent(location.hash.slice(1) || '');
const parseHash = () => {
  // patterns: "", "TORNEIO", "TORNEIO_Grupo-A"
  const h = rota();
  if(!h) return {scr:"home"};
  const mGrupo = h.match(/^(.+)_Grupo\-([A-H])$/);
  if(mGrupo) return {scr:"grupo", torneio:mGrupo[1], grupo:mGrupo[2]};
  return {scr:"grupos", torneio:h};
};
const go = (hash) => { location.hash = encodeURIComponent(hash).replace(/%20/g,' '); };

$("#btnBack").addEventListener("click", () => {
  window.location.href = "campeonato.html";
});

$("#tabGrupos").addEventListener("click",()=>{
  $("#tabGrupos").classList.add("active");$("#tabMata").classList.remove("active");
  $("#viewGrupos").style.display="block";$("#viewMata").style.display="none";
});
$("#tabMata").addEventListener("click",()=>{
  $("#tabMata").classList.add("active");$("#tabGrupos").classList.remove("active");
  $("#viewMata").style.display="block";$("#viewGrupos").style.display="none";
});

function getGroupKey(label){ // "Grupo E" -> "Grupo 5"
  const mLet = /grupo\s*([A-Z])/i.exec(label);
  const mNum = /grupo\s*(\d+)/i.exec(label);
  if (mNum) return `Grupo ${Number(mNum[1])}`;
  if (mLet){
    const pos = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".indexOf(mLet[1].toUpperCase());
    return pos >= 0 ? `Grupo ${pos+1}` : label;
  }
  return label;
}

// uso na tela:
const store = JSON.parse(localStorage.getItem('groups_plan_v1')||'{}');
const conf  = 'UEFA';                          // vindo do torneio atual
const uiGrp = 'GRUPO E';                       // vindo da UI
const key   = getGroupKey(uiGrp);              // -> "Grupo 5"
const teams = store?.[conf]?.[key] || [];      // agora encontra

/* === CARREGAR DADOS DO localStorage (compat) === */
function loadTorneios(){
  // Espera um array de objetos no localStorage.campeonatos
  try{
    const raw = localStorage.getItem("campeonatos");
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr)?arr:[];
  }catch(e){ return []; }
}

// Gera pares do turno único
function gerarPares(times){
  const n = times.length;
  const pares = [];
  for(let i=0;i<n;i++){
    for(let j=i+1;j<n;j++){
      pares.push({home:times[i], away:times[j]});
    }
  }
  return pares;
}

function tryLoadResultados(torneio, grupo){
  // Várias chaves possíveis para compatibilidade
  const keys = ["fixtures_results_v1","fixtures_plan_flat_v1","fixtures_group_results_v1"];
  for(const k of keys){
    try{
      const raw = localStorage.getItem(k);
      if(!raw) continue;
      const data = JSON.parse(raw);
      // suportar mapa por "TORNEIO:Grupo X" ou aninhado
      const label1 = `${torneio}:Grupo ${grupo}`;
      const label2 = `${torneio}-Grupo ${grupo}`;
      if(Array.isArray(data[label1])) return data[label1];
      if(Array.isArray(data[label2])) return data[label2];
      if(data[torneio] && data[torneio][grupo]) return data[torneio][grupo];
    }catch(e){}
  }
  return null;
}

function tryLoadKnockout(torneio){
  const keys = ["knockout_v1","mata_mata_v1"];
  for(const k of keys){
    try{
      const raw = localStorage.getItem(k);
      if(!raw) continue;
      const data = JSON.parse(raw);
      if(Array.isArray(data[torneio])) return data[torneio];
      if(data[torneio]) return data[torneio];
    }catch(e){}
  }
  return null;
}

/* Descobrir quantos grupos existem no torneio */
function getGroupCount(torneioNome){
  const t = state.torneios.find(x=>x.Nome===torneioNome) || {};
  // 1) se existir propriedade "Grupos" com número, usar
  if(typeof t.Grupos === "number" && t.Grupos>0) return t.Grupos;
  // 2) contar chaves "Grupo 1", "Grupo 2", ...
  let max = 0;
  Object.keys(t).forEach(k=>{
    const m = k.match(/^Grupo\s+(\d+)$/i);
    if(m) max = Math.max(max, parseInt(m[1],10));
  });
  if(max>0) return max;
  // 3) fallback 8
  return 8;
}

function extractTimesFromCampeonatos(torneioNome, grupoLetra){
  // Tentar stores dedicadas
  const storeKeys = ["groups_plan_v1","groups_p1an_v1"]; // inclui legado com 1 no lugar de l
  for(const storeKey of storeKeys){
    try{
      const raw = localStorage.getItem(storeKey);
      if(raw){
        const dict = JSON.parse(raw);
        const gKey1 = `${torneioNome}:Grupo ${grupoLetra}`;
        const gKey2 = `${torneioNome}-Grupo ${grupoLetra}`;
        if(Array.isArray(dict[gKey1])) return dict[gKey1];
        if(Array.isArray(dict[gKey2])) return dict[gKey2];
        if(dict[torneioNome] && Array.isArray(dict[torneioNome][grupoLetra])) return dict[torneioNome][grupoLetra];
      }
    }catch(e){}
  }
  // fallback: buscar dentro do objeto do torneio (Grupo 1..)
  const t = state.torneios.find(x=>x.Nome===torneioNome);
  const idx = "ABCDEFGH".indexOf(grupoLetra)+1;
  if(t && t[`Grupo ${idx}`] && Array.isArray(t[`Grupo ${idx}`])){
    return t[`Grupo ${idx}`];
  }
  // mais um fallback: chaves livres tipo "grupos_TORNEIO_GrupoA"
  const guessKeys = [
    `grupos_${torneioNome}_Grupo${grupoLetra}`,
    `${torneioNome}_Grupo${grupoLetra}`
  ];
  for(const k of guessKeys){
    try{
      const raw = localStorage.getItem(k);
      if(!raw) continue;
      const arr = JSON.parse(raw);
      if(Array.isArray(arr)) return arr;
    }catch(e){}
  }
  return null;
}

/* === UI BUILDERS === */
function renderHome(){
  $("#scrTorneios").classList.add("active");
  $("#scrGrupos").classList.remove("active");
  $("#scrGrupoView").classList.remove("active");

  const grid = $("#torneiosGrid");
  grid.innerHTML = "";
  state.torneios = loadTorneios();
  if(!state.torneios.length){
    grid.appendChild(el("div",{class:"warning", html:"Não encontrei <b>campeonatos</b> no seu <code>localStorage</code>.<br/>Abra o <b>campeonato.html</b> primeiro para popular os dados ou adicione manualmente."}));
    return;
  }

  state.torneios.forEach(t => {
    const card = el("div",{class:"card"});
    const row = el("div",{class:"row"});
    const img = el("img",{class:"logo", src: LOGOS[t.Nome] || LOGOS["FIFA"], alt:t.Nome});
    row.appendChild(img);
    row.appendChild(el("div",{html:`<div class="section-title" style="margin:0">${t.Nome}</div><div class="muted">Formato: ${t.Formato||"-"}</div>`}));
    const btn = el("div",{class:"item", style:"margin-top:.6rem"}, [
      el("div",{class:"row"},[ el("span",{class:"badge",text:"🏆"}), el("div",{text:"Abrir grupos"}) ]),
      el("span",{class:"pill", text:"ver"})
    ]);
    btn.addEventListener("click",()=>go(t.Nome));
    card.appendChild(row);
    card.appendChild(btn);
    grid.appendChild(card);
  });
}

function renderGrupos(torneioNome){
  $("#scrTorneios").classList.remove("active");
  $("#scrGrupoView").classList.remove("active");
  $("#scrGrupos").classList.add("active");

  const wrap = $("#gruposWrap");
  wrap.innerHTML = "";
  const header = el("div",{class:"row"},[
    el("img",{class:"logo",src:LOGOS[torneioNome]||LOGOS["FIFA"],alt:torneioNome}),
    el("div",{class:"section-title",text:torneioNome})
  ]);
  wrap.appendChild(header);

  const qtd = Math.max(1, Math.min(getGroupCount(torneioNome), 26)); // até Z por segurança
  for(let i=0;i<qtd;i++){
    const letra = ABC[i];
    const btn = el("div",{class:"item"},[
      el("div",{class:"row"},[el("span",{class:"badge",text:letra}),el("div",{text:`Grupo ${letra}`})]),
      el("span",{class:"pill",text:"abrir"})
    ]);
    btn.addEventListener("click",()=>go(`${torneioNome}_Grupo-${letra}`));
    wrap.appendChild(btn);
  }
}

function renderGrupoView(torneioNome, grupoLetra){
  $("#scrTorneios").classList.remove("active");
  $("#scrGrupos").classList.remove("active");
  $("#scrGrupoView").classList.add("active");

  $("#grupoHeader").innerHTML = "";
  $("#grupoHeader").appendChild(el("img",{class:"logo",src:LOGOS[torneioNome]||LOGOS["FIFA"],alt:torneioNome}));
  $("#grupoHeader").appendChild(el("div",{class:"section-title",text:`${torneioNome} • Grupo ${grupoLetra}` }));

  $("#fasePill").textContent = "Fase de Grupos";

  const tObj = state.torneios.find(x=>x.Nome===torneioNome) || {};
  if(tObj.Formato) $("#fasePill").textContent = tObj.Formato;

  const times = extractTimesFromCampeonatos(torneioNome, grupoLetra) || [];
  state.grupoTimes = times;
  state.torneio = torneioNome;
  state.grupoKey = `Grupo ${grupoLetra}`;

  // RESULTADOS
  const contRes = $("#resultados");
  contRes.innerHTML = "";

  if(times.length<2){
    contRes.appendChild(el("div",{class:"warning",html:"Não encontrei os <b>times</b> deste grupo no seu armazenamento.<br/>Popule <code>groups_plan_v1</code> (ou <code>groups_p1an_v1</code>) ou o objeto do torneio e recarregue."}));
  }else{
    // tenta carregar resultados reais
    const pares = gerarPares(times);
    const resultados = tryLoadResultados(torneioNome, grupoLetra);
    // indexar placares se existirem
    const scoreMap = new Map();
    if(Array.isArray(resultados)){
      resultados.forEach(m=>{
        const key = `${m.home}__${m.away}`;
        scoreMap.set(key, {gh:Number(m.gh)||0, ga:Number(m.ga)||0});
      });
    }

    const tbl = el("table");
    tbl.appendChild(el("thead",{}, el("tr",{},[
      el("th",{text:"Mandante"}),
      el("th",{text:"Placar"}),
      el("th",{text:"Visitante"})
    ])));
    const tb = el("tbody");
    pares.forEach(p=>{
      const s = scoreMap.get(`${p.home}__${p.away}`) || {gh:0,ga:0};
      tb.appendChild(el("tr",{},[
        el("td",{text:p.home}),
        el("td",{text:`${s.gh} × ${s.ga}`}),
        el("td",{text:p.away})
      ]));
    });
    tbl.appendChild(tb);
    contRes.appendChild(tbl);
  }

  // CLASSIFICAÇÃO
  const contClass = $("#classificacao");
  contClass.innerHTML = "";
  if(times.length){
    const stats = new Map();
    times.forEach(t=>stats.set(t,{J:0,V:0,E:0,D:0,GP:0,GC:0,SG:0,PTS:0,name:t}));
    // compute a partir de resultados (se houver)
    const resultados = tryLoadResultados(torneioNome, grupoLetra) || [];
    resultados.forEach(m=>{
      const gh = Number(m.gh)||0, ga = Number(m.ga)||0;
      if(!stats.has(m.home)||!stats.has(m.away)) return;
      const H = stats.get(m.home), A = stats.get(m.away);
      H.J++; A.J++;
      H.GP+=gh; H.GC+=ga; H.SG=H.GP-H.GC;
      A.GP+=ga; A.GC+=gh; A.SG=A.GP-A.GC;
      if(gh>ga){H.V++;A.D++;H.PTS+=3;}
      else if(gh<ga){A.V++;H.D++;A.PTS+=3;}
      else {H.E++;A.E++;H.PTS+=1;A.PTS+=1;}
    });
    const arr = [...stats.values()].sort((a,b)=> b.PTS-a.PTS || b.SG-a.SG || b.GP-a.GP || a.name.localeCompare(b.name));
    const tbl = el("table");
    tbl.appendChild(el("thead",{}, el("tr",{},[
      el("th",{text:"Seleção"}), el("th",{text:"J"}), el("th",{text:"V"}), el("th",{text:"E"}), el("th",{text:"D"}),
      el("th",{text:"GP"}), el("th",{text:"GC"}), el("th",{text:"SG"}), el("th",{text:"PTS"})
    ])));
    const tb = el("tbody");
    arr.forEach(t=>{
      tb.appendChild(el("tr",{},[
        el("td",{text:t.name}), el("td",{text:t.J}), el("td",{text:t.V}), el("td",{text:t.E}), el("td",{text:t.D}),
        el("td",{text:t.GP}), el("td",{text:t.GC}), el("td",{text:t.SG}), el("td",{text:t.PTS})
      ]));
    });
    tbl.appendChild(tb);
    contClass.appendChild(tbl);
  }else{
    contClass.appendChild(el("div",{class:"warning",text:"Sem times no grupo."}));
  }

  // MATA-MATA (opcional)
  const knockWrap = $("#knockout");
  knockWrap.innerHTML = "";
  const knockout = tryLoadKnockout(torneioNome);
  if(!knockout){
    knockWrap.appendChild(el("div",{class:"warning",text:"Nenhuma chave de mata‑mata encontrada para este torneio."}));
  }else{
    const list = el("div",{class:"list"});
    knockout.forEach(match=>{
      // match esperado: {fase:'Quartas', home:'X', away:'Y', gh:?, ga:?}
      const linha = el("div",{class:"item"},[
        el("div",{class:"row"},[
          el("span",{class:"badge",text:match.fase?.[0]||'M'}),
          el("div",{html:`<div>${match.fase||'Jogo'}</div><div class="muted">${match.home||'??'} × ${match.away||'??'} ${typeof match.gh==='number' && typeof match.ga==='number' ? `(${match.gh}–${match.ga})` : ''}</div>`})
        ])
      ]);
      list.appendChild(linha);
    });
    knockWrap.appendChild(list);
  }
}

/* === INIT / ROUTER === */
function syncRoute(){
  const h = parseHash();
  if(h.scr==="home"){ renderHome(); }
  else if(h.scr==="grupos"){ renderGrupos(h.torneio); }
  else if(h.scr==="grupo"){ renderGrupoView(h.torneio, h.grupo); }
}
window.addEventListener("hashchange", syncRoute);
window.addEventListener("load", ()=>{
  syncRoute();
  $("#btnVoltarCampeonato").addEventListener("click",()=>{
    const h = parseHash();
    go(h.torneio || "");
  });
});
</script>
</body>
</html>
