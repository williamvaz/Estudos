<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=0.1, shrink-to-fit=yes">
  <title>Estudos Futebol ‚Ä¢ Palavras</title>
  <link rel="stylesheet" href="home.css">

  <!-- √çcones -->
  <link rel="icon" type="image/webp" href="icone.webp" />
  <link rel="apple-touch-icon" href="icone.webp" />

  <style>
    :root { color-scheme: dark; }
    body { color: #fff; }
    a { color: #fff; text-decoration: underline; }
    .container { max-width: 980px; margin: 0 auto; padding: 12px; }
    .card { background: rgba(0,0,0,.15); border: 1px solid rgba(255,255,255,.08);
            border-radius: 14px; padding: 12px; }
    .topbar .brand { display:flex; align-items:center; gap:10px; padding:12px; }
    .topbar h1 { font-size: 1.25rem; margin:0; }
    .small { font-size:.9rem; opacity:.8; }
    .muted { opacity:.85; }
    .grid { display:grid; gap:12px; }
    .header-row { display:flex; align-items:center; gap:12px; flex-wrap: wrap; }
    .spacer { flex:1 }
    .input { width: 260px; max-width: 100%; background:#0f1f15; color:#fff; border:1px solid #284b34; border-radius:10px; padding:10px 12px; }

    /* --- filtros --- */
    .filters { display:grid; gap:10px; }
    @media (min-width: 720px){ .filters { grid-template-columns: 1fr 1fr; } }
    fieldset { border:1px dashed rgba(255,255,255,.15); border-radius:12px; padding:10px 12px; }
    fieldset legend { padding:0 6px; font-size:.9rem; opacity:.85; }
    .checks { display:flex; flex-wrap:wrap; gap:8px 10px; }
    .chip {
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; border:1px solid #284b34; background:#102618;
      font-size:.9rem; cursor:pointer; user-select:none;
    }
    .chip input { accent-color:#2fb36c; }

    /* --- stat cards --- */
    .stats { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:10px; }
    @media (min-width: 560px) { .stats { grid-template-columns: repeat(4,minmax(0,1fr)); } }
    .stat { display:flex; flex-direction:column; gap:4px; padding:10px 12px;
            border-radius:12px; background:#102618; border:1px solid #284b34; }
    .stat-label { font-size:.85rem; opacity:.8; }
    .stat-value { font-size:1.4rem; font-weight:700; }

    /* tabela */
    .table-wrap { overflow-x: visible; }
    #words-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: .95rem;
    }
    #words-table th, #words-table td {
      padding: 6px 8px;
      white-space: normal;
      word-break: break-word;
      overflow: visible;
    }
    /* Larguras: 3 colunas (sem n√≠vel) */
    #words-table th:nth-child(1), #words-table td:nth-child(1) { width: 50%; } /* Word  */
    #words-table th:nth-child(2), #words-table td:nth-child(2) { width: 25%; } /* Definition */
    #words-table th:nth-child(3), #words-table td:nth-child(3) { width: 25%; } /* Voice */

    #words-table td a {
      display:inline-block; max-width:100%;
      overflow:hidden; text-overflow:ellipsis;
      vertical-align: middle;
    }
    #words-table audio {
      display:block;
      width: 100%;
      max-width: 180px;
      height: 32px;
    }
    @media (min-width: 560px){
      #words-table audio { max-width: 220px; }
    }

    .badge { padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.05); }
    .nowrap { white-space:nowrap; }

    /* Compacta√ß√£o geral no S23 */
    html { font-size: 15px; }
    @media (max-width: 390px){ html{ font-size:14px; } }
    .topbar h1 { font-size: 1.05rem; }
    .stat-value { font-size: 1.15rem; }
    .stat-label { font-size: .8rem; }
  </style>
</head>
<body class="is-mobile">
  <header class="topbar">
    <div class="brand card">
      <span style="font-size:20px">üìö</span>
      <h1>Lista de Palavras</h1>
      <a class="small" href="index.html" style="margin-left:auto">‚Üê In√≠cio</a>
    </div>
  </header>

  <main class="container grid">
    <!-- filtros -->
    <section class="card">
      <h2 style="margin:0 0 8px">Banco de palavras</h2>
      <div class="header-row" style="margin-top:8px">
        <input id="search" class="input" type="search" placeholder="Buscar palavra (ex.: house)" />
        <div class="spacer"></div>
        <span class="small muted">Dados de <code>words.json</code> + mem√≥ria no <code>localStorage</code></span>
      </div>

      <div class="filters" style="margin-top:10px">
        <fieldset>
          <legend>Filtrar por Level (CEFR)</legend>
          <div id="f-level" class="checks"></div>
          <div class="small muted" style="margin-top:6px">Selecione um ou mais n√≠veis. Sem sele√ß√£o = todos.</div>
        </fieldset>
        <fieldset>
          <legend>Filtrar por Mem√≥ria</legend>
          <div id="f-mem" class="checks"></div>
          <div class="small muted" style="margin-top:6px">Valores lidos do localStorage. Sem sele√ß√£o = todos.</div>
        </fieldset>
      </div>
    </section>

    <!-- stats (mem√≥ria) -->
    <section class="stats">
      <div class="stat">
        <div class="stat-label">Mem√≥ria ‚â• 1</div>
        <div class="stat-value" id="stat-m1">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Mem√≥ria ‚â• 5</div>
        <div class="stat-value" id="stat-m5">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Mem√≥ria ‚â• 8</div>
        <div class="stat-value" id="stat-m8">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Mem√≥ria ‚â• 10</div>
        <div class="stat-value" id="stat-m10">0</div>
      </div>
    </section>

    <!-- tabela -->
    <section class="card table-wrap">
      <table id="words-table">
        <thead>
          <tr>
            <th>Word</th>
            <th>Definition</th>
            <th>Voice</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </section>
  </main>

  <script>
    // --------- config ----------
    const LKEY = 'words_info'; // { [word__pos]: { word, level, pos, definition_url, voice_url, "Memoria", "Proxima revis√£o" } }

    // --------- storage helpers ----------
    const loadStore = () => {
      try { return JSON.parse(localStorage.getItem(LKEY) || '{}'); }
      catch { return {}; }
    };
    const saveStore = (db) => localStorage.setItem(LKEY, JSON.stringify(db));

    // --------- helpers ----------
    const makeId = (w) => `${w.word}__${w.pos || ''}`;

    // Mant√©m level exatamente como veio do JSON (CEFR: a1/b2/etc.)
    function normalizeWords(raw) {
      return (raw || [])
        .map(w => ({
          word: String(w.word || '').trim(),
          level: (w.level ?? '').toString().trim(),
          pos: w.pos || '',
          definition_url: w.definition_url || '',
          voice_url: w.voice_url || ''
        }))
        .filter(w => w.word);
    }

    // Cria/atualiza o registro no localStorage com os campos solicitados
    function ensureEntry(db, w) {
      const id = makeId(w);
      if (!db[id]) {
        db[id] = {
          word: w.word,
          level: w.level,                 // CEFR como no JSON
          pos: w.pos || '',
          definition_url: w.definition_url || '',
          voice_url: w.voice_url || '',
          "Memoria": 0,                   // primeiro registro = 0
          "Proxima revis√£o": 100000       // primeiro registro = 100000
        };
      } else {
        // Sincroniza com o words.json (n√£o altera Memoria/Proxima revis√£o)
        db[id].word = w.word;
        db[id].level = w.level;
        db[id].pos = w.pos || '';
        db[id].definition_url = w.definition_url || '';
        db[id].voice_url = w.voice_url || '';
      }
    }

    // --------- estado ---------
    let DB = {};      // mapa salvo no localStorage
    let WORDS = [];   // words.json normalizado (base de render)

    // --------- filtros (estado UI) ---------
    let selectedLevels = new Set();   // CEFR (ex.: 'a1','b2'...)
    let selectedMem = new Set();      // n√∫meros inteiros (ex.: 0,1,2,...)

    // util de leitura das sele√ß√µes
    function readSelections(name) {
      return new Set(
        Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(el => el.value)
      );
    }

    function buildLevelFilter() {
      const wrap = document.getElementById('f-level');
      if (!wrap) return;

      const allLevels = Array.from(new Set(Object.values(DB)
        .map(x => (x.level || '').toLowerCase())
        .filter(Boolean)))
        .sort((a,b) => a.localeCompare(b, 'en'));

      wrap.innerHTML = allLevels.map(lvl => `
        <label class="chip">
          <input type="checkbox" name="fLevel" value="${lvl}">
          <span>${lvl.toUpperCase()}</span>
        </label>
      `).join('') || `<span class="small muted">Sem n√≠veis para filtrar.</span>`;

      wrap.addEventListener('change', () => {
        selectedLevels = readSelections('fLevel');
        renderTable(document.getElementById('search')?.value || '');
      });
    }

    function buildMemFilter() {
      const wrap = document.getElementById('f-mem');
      if (!wrap) return;

      const allMem = Array.from(new Set(Object.values(DB)
        .map(x => Number(x["Memoria"] ?? 0))
        .filter(n => Number.isFinite(n))))
        .sort((a,b) => a - b);

      wrap.innerHTML = allMem.map(n => `
        <label class="chip">
          <input type="checkbox" name="fMem" value="${n}">
          <span>M${n}</span>
        </label>
      `).join('') || `<span class="small muted">Sem valores de mem√≥ria no localStorage.</span>`;

      wrap.addEventListener('change', () => {
        selectedMem = new Set(Array.from(readSelections('fMem')).map(v => Number(v)));
        renderTable(document.getElementById('search')?.value || '');
        renderCount(); // manter cart√µes atualizados mesmo quando o usu√°rio mexe em filtros
      });
    }

    // --------- UI: cards de contagem (baseados em MEM√ìRIA) ---------
    function renderCount() {
      const vals = Object.values(DB).map(x => Number(x["Memoria"] ?? 0));

      const m1  = vals.filter(v => v >= 1).length;
      const m5  = vals.filter(v => v >= 5).length;
      const m8  = vals.filter(v => v >= 8).length;
      const m10 = vals.filter(v => v >= 10).length;

      const setText = (id, n) => { const el = document.getElementById(id); if (el) el.textContent = String(n); }
      setText('stat-m1',  m1);
      setText('stat-m5',  m5);
      setText('stat-m8',  m8);
      setText('stat-m10', m10);
    }

    // --------- UI: tabela ---------
    function renderTable(filterText = '') {
      const q = (filterText || '').trim().toLowerCase();
      const tbody = document.getElementById('tb');
      if (!tbody) return;

      const rows = Object.values(DB)
        .filter(item => !q || item.word.toLowerCase().includes(q))
        // filtro CEFR: se nada selecionado, n√£o filtra; se houver, precisa estar em selectedLevels
        .filter(item => selectedLevels.size === 0 || selectedLevels.has((item.level || '').toLowerCase()))
        // filtro Mem√≥ria: se nada selecionado, n√£o filtra; se houver, precisa EQUAL a um dos selecionados
        .filter(item => {
          if (selectedMem.size === 0) return true;
          const m = Number(item["Memoria"] ?? 0);
          return selectedMem.has(m);
        })
        .sort((a, b) => a.word.localeCompare(b.word) || (a.pos||'').localeCompare(b.pos||''))
        .map(item => {
          const def = item.definition_url ? `<a href="${item.definition_url}" target="_blank" rel="noopener">abrir</a>` : '';
          const voc = item.voice_url ? `<audio controls preload="none"><source src="${item.voice_url}"></audio>` : '';
          const pos = item.pos ? ` <span class="small muted">(${item.pos})</span>` : '';
          return `<tr>
            <td class="nowrap">${item.word}${pos}</td>
            <td>${def}</td>
            <td>${voc}</td>
          </tr>`;
        }).join('');

      tbody.innerHTML = rows || `<tr><td colspan="3" class="muted">Nenhuma palavra encontrada.</td></tr>`;
    }

    // --------- boot ---------
    (async function init() {
      try {
        const res = await fetch('words.json', { cache: 'no-store' });
        WORDS = res.ok ? normalizeWords(await res.json()) : [];
      } catch (e) {
        console.warn('Falha ao carregar words.json', e);
        WORDS = [];
      }

      // carrega o que j√° havia e garante as entradas m√≠nimas
      DB = loadStore();
      WORDS.forEach(w => ensureEntry(DB, w));
      saveStore(DB); // persiste ap√≥s normalizar

      // construir filtros com base no DB preenchido
      buildLevelFilter();
      buildMemFilter();

      // render cards e tabela
      renderCount();
      renderTable();

      // busca por texto
      const search = document.getElementById('search');
      if (search) {
        search.addEventListener('input', (e) => renderTable(e.target.value));
      }
    })();
  </script>
</body>
</html>